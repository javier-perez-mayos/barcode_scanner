<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ISBN-13 Scanner</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCode Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Custom animations for the scanner overlay */
        @keyframes scan-line {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-sizing: border-box;
            border-radius: 0.5rem;
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ef4444; /* Red laser line */
            animation: scan-line 2s infinite linear;
            box-shadow: 0 0 4px #ef4444;
        }

        /* Hide the library's default video overlay info to keep UI clean */
        #reader__dashboard_section_csr span { display: none !important; }
        
        /* Ensure video fills container nicely */
        #reader video {
            object-fit: cover;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <div class="max-w-md mx-auto p-4 flex flex-col h-screen">
        
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-900">ISBN Scanner</h1>
            <p class="text-sm text-gray-500">Scan book barcodes (EAN-13)</p>
        </header>

        <!-- Main Scanner Area -->
        <main class="flex-grow flex flex-col items-center justify-start space-y-4">
            
            <!-- Camera Viewport -->
            <div id="reader-container" class="relative w-full aspect-square bg-black rounded-lg overflow-hidden shadow-lg border-4 border-gray-800 hidden">
                <div id="reader" class="w-full h-full"></div>
                <!-- Visual Guide Overlay -->
                <div class="scan-overlay hidden" id="scan-overlay">
                    <div class="scan-line"></div>
                </div>
                <!-- Stop Button Overlay -->
                <button id="stop-btn" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-lg font-semibold text-sm active:scale-95 transition-transform z-10">
                    Stop Camera
                </button>
            </div>

            <!-- Start UI (Shown when camera is off) -->
            <div id="start-ui" class="w-full flex flex-col items-center justify-center bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h.01M9 20h.01M12 20h.01M15 20h.01M16 3h5m-5 5h5m-5 5h5m-5 5h5M3 3h5m-5 5h5m-5 5h5m-5 5h5" />
                    </svg>
                </div>
                <p class="text-center text-gray-600 mb-6">Point your camera at the barcode on the back of a book.</p>
                <!-- Camera selection (hidden until cameras enumerated) -->
                <div class="w-full mb-4 hidden" id="camera-select-wrapper">
                    <label for="camera-select" class="block text-xs font-semibold text-gray-500 mb-1">Camera</label>
                    <select id="camera-select" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Tap to Scan
                </button>
                <p class="text-xs text-red-500 mt-4 hidden" id="error-msg"></p>
            </div>

            <!-- Result Area (Populates after scan) -->
            <div id="result-card" class="w-full bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hidden transition-all">
                <div class="p-4 bg-green-50 border-b border-green-100 flex justify-between items-center">
                    <span class="text-green-700 font-bold text-sm flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        ISBN Detected
                    </span>
                    <button onclick="copyToClipboard()" class="text-xs text-blue-600 font-semibold hover:underline">Copy</button>
                </div>
                <div class="p-4 flex gap-4">
                    <!-- Book Cover Placeholder -->
                    <div class="flex-shrink-0 w-20 h-28 bg-gray-200 rounded shadow-sm overflow-hidden relative">
                        <img id="book-cover" src="" alt="Cover" class="w-full h-full object-cover hidden">
                        <div id="no-cover" class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs text-center p-1">No Cover</div>
                    </div>
                    
                    <div class="flex-grow min-w-0">
                        <h2 id="book-title" class="font-bold text-lg leading-tight text-gray-900 truncate">Fetching info...</h2>
                        <p id="book-author" class="text-sm text-gray-600 mt-1 truncate">...</p>
                        <div class="mt-3 bg-gray-100 rounded px-2 py-1 inline-block">
                            <code id="isbn-display" class="text-sm font-mono text-gray-800 font-bold"></code>
                        </div>
                    </div>
                </div>
                <div class="px-4 py-3 bg-gray-50 flex gap-2">
                    <button onclick="resetScanner()" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 rounded-lg text-sm font-semibold hover:bg-gray-50 transition-colors">
                        Scan Another
                    </button>
                    <a id="amazon-link" href="#" target="_blank" class="flex-1 bg-yellow-400 text-yellow-900 py-2 rounded-lg text-sm font-semibold text-center hover:bg-yellow-500 transition-colors">
                        View on Amazon
                    </a>
                </div>
            </div>

        </main>
        
        <footer class="text-center text-gray-400 text-xs py-4">
            Powered by html5-qrcode & OpenLibrary
        </footer>

    </div>

    <!-- Audio for beep sound -->
    <audio id="scan-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const readerContainer = document.getElementById('reader-container');
        const startUi = document.getElementById('start-ui');
        const scanOverlay = document.getElementById('scan-overlay');
        const resultCard = document.getElementById('result-card');
        const errorMsg = document.getElementById('error-msg');
        
        // Result elements
        const isbnDisplay = document.getElementById('isbn-display');
        const bookTitle = document.getElementById('book-title');
        const bookAuthor = document.getElementById('book-author');
        const bookCover = document.getElementById('book-cover');
        const noCover = document.getElementById('no-cover');
        const amazonLink = document.getElementById('amazon-link');
        const scanSound = document.getElementById('scan-sound');
        const cameraSelectWrapper = document.getElementById('camera-select-wrapper');
        const cameraSelect = document.getElementById('camera-select');

        let isScanning = false;

        // Config for the scanner
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 150 }, // Rectangular box for barcodes
            aspectRatio: 1.0,
            formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13 ], // Optimize for ISBN
            // Move video constraints here (second argument accepts extended config)
            videoConstraints: {
                facingMode: "environment",
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 },
                focusMode: "continuous",
                advanced: [{ focusMode: "continuous" }]
            }
        };

        startBtn.addEventListener('click', startScanning);
        stopBtn.addEventListener('click', stopScanning);

        // Enumerate cameras early (permission prompt may appear)
        initCameraSelection();

        async function initCameraSelection() {
            try {
                const cameras = await Html5Qrcode.getCameras();
                if (!cameras || cameras.length === 0) {
                    cameraSelectWrapper.classList.add('hidden');
                    return;
                }
                // Populate select
                cameraSelect.innerHTML = '';
                cameras.forEach((cam, idx) => {
                    const opt = document.createElement('option');
                    opt.value = cam.id;
                    opt.textContent = cam.label || `Camera ${idx + 1}`;
                    cameraSelect.appendChild(opt);
                });
                cameraSelectWrapper.classList.remove('hidden');
                // If only one camera, keep it visible for info but could hide if desired
            } catch (e) {
                console.warn('Camera enumeration failed, fallback to facingMode.', e);
                cameraSelectWrapper.classList.add('hidden');
            }
        }

        async function startScanning() {
            try {
                // UI updates
                startUi.classList.add('hidden');
                resultCard.classList.add('hidden');
                readerContainer.classList.remove('hidden');
                errorMsg.classList.add('hidden');
                
                // Start the scanner
                // Pass a single-key object as first param (camera selector)
                const selectedDeviceId = cameraSelect && cameraSelect.value;
                if (selectedDeviceId) {
                    // Start by deviceId (string)
                    await html5QrCode.start(
                        selectedDeviceId,
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                } else {
                    // Fallback using facingMode
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                }
                
                isScanning = true;
                scanOverlay.classList.remove('hidden'); // Show the red laser line

            } catch (err) {
                console.error("Error starting scanner", err);
                readerContainer.classList.add('hidden');
                startUi.classList.remove('hidden');
                errorMsg.textContent = "Camera access denied or error. Please ensure you are on HTTPS.";
                errorMsg.classList.remove('hidden');
            }
        }

        async function stopScanning() {
            if (isScanning) {
                try {
                    await html5QrCode.stop();
                    readerContainer.classList.add('hidden');
                    scanOverlay.classList.add('hidden');
                    startUi.classList.remove('hidden');
                    isScanning = false;
                } catch (err) {
                    console.error("Failed to stop", err);
                }
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Stop scanning once found
            stopScanning();
            playBeep();
            
            // Show result card
            startUi.classList.add('hidden');
            resultCard.classList.remove('hidden');
            
            // Display basic ISBN
            isbnDisplay.textContent = decodedText;
            
            // Generate Amazon Link
            amazonLink.href = `https://www.amazon.com/s?k=${decodedText}`;

            // Fetch book details
            fetchBookDetails(decodedText);
        }

        function onScanFailure(error) {
            // Use this strictly for debugging, don't update UI here as it fires on every frame check
            // console.warn(`Code scan error = ${error}`);
        }

        function playBeep() {
            // Haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            // Audio feedback
            scanSound.play().catch(e => console.log('Audio play failed', e));
        }

        async function fetchBookDetails(isbn) {
            // Reset UI
            bookTitle.textContent = "Loading info...";
            bookAuthor.textContent = "";
            bookCover.classList.add('hidden');
            noCover.classList.remove('hidden');

            try {
                const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&jscmd=data&format=json`);
                const data = await response.json();
                const bookKey = `ISBN:${isbn}`;

                if (data[bookKey]) {
                    const book = data[bookKey];
                    bookTitle.textContent = book.title || "Unknown Title";
                    bookAuthor.textContent = book.authors ? book.authors.map(a => a.name).join(", ") : "Unknown Author";
                    
                    if (book.cover && book.cover.medium) {
                        bookCover.src = book.cover.medium;
                        bookCover.classList.remove('hidden');
                        noCover.classList.add('hidden');
                    }
                } else {
                    bookTitle.textContent = "Book details not found";
                    bookAuthor.textContent = "Try the Amazon link";
                }
            } catch (error) {
                console.error("API Error", error);
                bookTitle.textContent = "Network Error";
            }
        }

        function resetScanner() {
            resultCard.classList.add('hidden');
            startScanning();
        }
        
        function copyToClipboard() {
            const isbn = isbnDisplay.textContent;
            navigator.clipboard.writeText(isbn).then(() => {
                alert("ISBN copied to clipboard!");
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }
    </script>
</body>
</html>